<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stealth Vault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        @keyframes gradient {
            0% {background-position: 0% 50%;}
            50% {background-position: 100% 50%;}
            100% {background-position: 0% 50%;}
        }
        
        .gradient-bg {
            background: linear-gradient(-45deg, #111827, #1e293b, #334155, #475569);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        .vault-container {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .vault-container:hover {
            box-shadow: 0 0 35px rgba(59, 130, 246, 0.5);
        }
        
        .file-thumbnail {
            transition: all 0.2s ease;
        }
        
        .file-thumbnail:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .passkey-input-container {
            position: relative;
        }
        
        .toggle-passkey {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
        }
        
        .toggle-passkey:hover {
            color: #3b82f6;
        }
        
        .hidden {
            display: none !important;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .glow-effect {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            transition: box-shadow 0.3s ease;
        }
        
        .glow-effect:hover {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
        }
        
        .alert-message {
            z-index: 100;
        }
        
        @media (max-width: 640px) {
            .file-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
    <!-- Passkey Screen -->
    <div id="passkeyScreen" class="w-full max-w-md mx-auto">
        <div class="vault-container bg-gray-900 bg-opacity-80 rounded-xl p-8 text-white fade-in">
            <div class="text-center mb-8">
                <div class="glow-effect inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-800 mb-4">
                    <i class="fas fa-lock-open text-3xl text-blue-400"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Stealth Vault</h1>
                <p class="text-gray-300">Your private offline file storage</p>
            </div>
            
            <div id="newPasskeyForm" class="hidden">
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Set your passkey</label>
                    <div class="passkey-input-container">
                        <input type="password" id="newPasskey" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                        <i class="fas fa-eye toggle-passkey" id="toggleNewPasskey"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Enter a secure passkey (8-16 characters)</p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Confirm passkey</label>
                    <div class="passkey-input-container">
                        <input type="password" id="confirmPasskey" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                        <i class="fas fa-eye toggle-passkey" id="toggleConfirmPasskey"></i>
                    </div>
                </div>
                <button id="setPasskeyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-key mr-2"></i> Set Passkey
                </button>
            </div>
            
            <div id="existingPasskeyForm">
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2">Enter your passkey</label>
                    <div class="passkey-input-container">
                        <input type="password" id="passkey" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                        <i class="fas fa-eye toggle-passkey" id="togglePasskey"></i>
                    </div>
                </div>
                <button id="unlockBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <i class="fas fa-unlock mr-2"></i> Unlock Vault
                </button>
                <button id="resetPasskeyBtn" class="text-blue-400 hover:text-blue-300 text-sm mt-4">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Forgot passkey? (This will reset your vault)
                </button>
            </div>
        </div>
    </div>
    
    <!-- Vault Screen -->
    <div id="vaultScreen" class="hidden w-full max-w-6xl mx-auto">
        <div class="vault-container bg-gray-900 bg-opacity-80 rounded-xl p-6 text-white">
            <!-- Header -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center">
                    <div class="glow-effect inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-800 mr-3">
                        <i class="fas fa-lock text-xl text-blue-400"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Stealth Vault</h1>
                        <p class="text-xs text-gray-400">Offline & Secure</p>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <button id="lockBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-200 flex-1 sm:flex-none justify-center">
                        <i class="fas fa-lock mr-2"></i> Lock
                    </button>
                    <button id="changePasskeyBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center transition duration-200 flex-1 sm:flex-none justify-center">
                        <i class="fas fa-key mr-2"></i> Change Passkey
                    </button>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div class="flex flex-wrap gap-2 w-full md:w-auto">
                    <button id="addFolderBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-200">
                        <i class="fas fa-folder-plus mr-2"></i> New Folder
                    </button>
                    <button id="addFilesBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-200">
                        <i class="fas fa-file-upload mr-2"></i> Add Files
                    </button>
                    <input type="file" id="fileInput" class="hidden" multiple accept="image/*,video/*">
                </div>
                <div class="relative w-full md:w-64">
                    <input type="text" id="searchInput" placeholder="Search files..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                </div>
            </div>
            
            <!-- Breadcrumbs -->
            <div id="breadcrumbs" class="flex items-center flex-wrap text-sm text-gray-300 mb-4 gap-1">
                <span class="cursor-pointer hover:text-blue-400 flex items-center" data-path="">
                    <i class="fas fa-vault mr-1"></i> Vault
                </span>
            </div>
            
            <!-- File Browser -->
            <div id="fileBrowser" class="file-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 min-h-[400px]">
                <!-- Files and folders will be displayed here -->
                <div class="col-span-full text-center text-gray-400 py-20">
                    <i class="fas fa-folder-open text-4xl mb-2"></i>
                    <p>Your vault is empty</p>
                    <button id="addFirstFilesBtn" class="mt-4 text-blue-400 hover:text-blue-300 underline flex items-center justify-center mx-auto">
                        <i class="fas fa-plus mr-1"></i> Add your first files
                    </button>
                </div>
            </div>
            
            <!-- Storage Usage -->
            <div class="mt-6 pt-4 border-t border-gray-700">
                <div class="flex justify-between items-center text-sm text-gray-300 mb-1">
                    <span>Storage Used</span>
                    <span id="storageUsed">0 MB</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="storageBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- File Viewer Modal -->
    <div id="fileViewerModal" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="relative max-w-4xl w-full">
            <button id="closeViewerBtn" class="absolute -top-12 right-0 text-white text-3xl hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
            <div class="bg-gray-900 rounded-lg overflow-hidden">
                <div id="fileViewerContent" class="flex justify-center items-center max-h-[80vh]">
                    <!-- File content will be displayed here -->
                </div>
                <div class="bg-gray-800 p-4 flex flex-col sm:flex-row justify-between items-center gap-2">
                    <div id="fileNameDisplay" class="text-white truncate max-w-xs"></div>
                    <div class="flex gap-2">
                        <button id="downloadFileBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center transition duration-200">
                            <i class="fas fa-download mr-2"></i> Download
                        </button>
                        <button id="deleteFileBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-200">
                            <i class="fas fa-trash mr-2"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Folder Modal -->
    <div id="newFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-folder-plus text-blue-400 mr-2"></i> Create New Folder
            </h2>
            <input type="text" id="folderNameInput" placeholder="Folder name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <div class="flex justify-end space-x-3">
                <button id="cancelFolderBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="createFolderBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    Create
                </button>
            </div>
        </div>
    </div>
    
    <!-- Change Passkey Modal -->
    <div id="changePasskeyModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                <i class="fas fa-key text-blue-400 mr-2"></i> Change Passkey
            </h2>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">Current passkey</label>
                <div class="passkey-input-container">
                    <input type="password" id="currentPasskey" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                    <i class="fas fa-eye toggle-passkey" id="toggleCurrentPasskey"></i>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-300 mb-2">New passkey</label>
                <div class="passkey-input-container">
                    <input type="password" id="newPasskeyModal" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                    <i class="fas fa-eye toggle-passkey" id="toggleNewPasskeyModal"></i>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-gray-300 mb-2">Confirm new passkey</label>
                <div class="passkey-input-container">
                    <input type="password" id="confirmNewPasskey" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-center focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" maxlength="16">
                    <i class="fas fa-eye toggle-passkey" id="toggleConfirmNewPasskey"></i>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelPasskeyChangeBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="confirmPasskeyChangeBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    Change
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md">
            <h2 id="confirmationTitle" class="text-xl font-bold text-white mb-4 flex items-center">
                <i id="confirmationIcon" class="fas fa-exclamation-circle text-red-400 mr-2"></i>
                <span>Confirm Action</span>
            </h2>
            <p id="confirmationMessage" class="text-gray-300 mb-6">Are you sure you want to perform this action?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelConfirmBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    Cancel
                </button>
                <button id="confirmActionBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Vault state
        const vaultState = {
            passkey: localStorage.getItem('vaultPasskey') ? decryptData(localStorage.getItem('vaultPasskey')) : null,
            currentPath: '',
            files: localStorage.getItem('vaultFiles') ? JSON.parse(decryptData(localStorage.getItem('vaultFiles'))) : [],
            selectedFile: null,
            confirmAction: null
        };
        
        // Encryption salt (would be more secure if generated per user in a real app)
        const encryptionSalt = "stealth-vault-salt-2023";
        
        // DOM Elements
        const passkeyScreen = document.getElementById('passkeyScreen');
        const vaultScreen = document.getElementById('vaultScreen');
        const fileViewerModal = document.getElementById('fileViewerModal');
        const newFolderModal = document.getElementById('newFolderModal');
        const changePasskeyModal = document.getElementById('changePasskeyModal');
        const confirmationModal = document.getElementById('confirmationModal');
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Check if passkey is set
            if (!vaultState.passkey) {
                document.getElementById('newPasskeyForm').classList.remove('hidden');
                document.getElementById('existingPasskeyForm').classList.add('hidden');
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Set up passkey visibility toggles
            setupPasskeyToggles();
            
            // Update storage display
            updateStorageUsage();
        });
        
        function setupEventListeners() {
            // Passkey screen
            document.getElementById('unlockBtn').addEventListener('click', unlockVault);
            document.getElementById('setPasskeyBtn').addEventListener('click', setPasskey);
            document.getElementById('resetPasskeyBtn').addEventListener('click', resetPasskey);
            
            // Vault screen
            document.getElementById('lockBtn').addEventListener('click', lockVault);
            document.getElementById('changePasskeyBtn').addEventListener('click', showChangePasskeyModal);
            document.getElementById('addFolderBtn').addEventListener('click', showNewFolderModal);
            document.getElementById('addFilesBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('addFirstFilesBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('searchInput').addEventListener('input', searchFiles);
            
            // File viewer
            document.getElementById('closeViewerBtn').addEventListener('click', () => fileViewerModal.classList.add('hidden'));
            document.getElementById('downloadFileBtn').addEventListener('click', downloadSelectedFile);
            document.getElementById('deleteFileBtn').addEventListener('click', confirmDeleteFile);
            
            // New folder modal
            document.getElementById('cancelFolderBtn').addEventListener('click', () => newFolderModal.classList.add('hidden'));
            document.getElementById('createFolderBtn').addEventListener('click', createNewFolder);
            
            // Change passkey modal
            document.getElementById('cancelPasskeyChangeBtn').addEventListener('click', () => changePasskeyModal.classList.add('hidden'));
            document.getElementById('confirmPasskeyChangeBtn').addEventListener('click', changePasskey);
            
            // Confirmation modal
            document.getElementById('cancelConfirmBtn').addEventListener('click', () => confirmationModal.classList.add('hidden'));
            document.getElementById('confirmActionBtn').addEventListener('click', executeConfirmedAction);
            
            // Allow pressing Enter in various fields
            document.getElementById('passkey')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') unlockVault();
            });
            
            document.getElementById('newPasskey')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setPasskey();
            });
            
            document.getElementById('confirmPasskey')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setPasskey();
            });
            
            document.getElementById('currentPasskey')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') changePasskey();
            });
            
            document.getElementById('newPasskeyModal')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') changePasskey();
            });
            
            document.getElementById('confirmNewPasskey')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') changePasskey();
            });
            
            document.getElementById('folderNameInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') createNewFolder();
            });
        }
        
        function setupPasskeyToggles() {
            // Setup passkey visibility toggles
            const togglePasskey = (inputId, toggleId) => {
                const input = document.getElementById(inputId);
                const toggle = document.getElementById(toggleId);
                
                toggle.addEventListener('click', () => {
                    if (input.type === 'password') {
                        input.type = 'text';
                        toggle.classList.replace('fa-eye', 'fa-eye-slash');
                    } else {
                        input.type = 'password';
                        toggle.classList.replace('fa-eye-slash', 'fa-eye');
                    }
                });
            };
            
            togglePasskey('passkey', 'togglePasskey');
            togglePasskey('newPasskey', 'toggleNewPasskey');
            togglePasskey('confirmPasskey', 'toggleConfirmPasskey');
            togglePasskey('currentPasskey', 'toggleCurrentPasskey');
            togglePasskey('newPasskeyModal', 'toggleNewPasskeyModal');
            togglePasskey('confirmNewPasskey', 'toggleConfirmNewPasskey');
        }
        
        // Encryption functions
        function encryptData(data) {
            return CryptoJS.AES.encrypt(JSON.stringify(data), vaultState.passkey + encryptionSalt).toString();
        }
        
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, vaultState.passkey + encryptionSalt);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                console.error("Decryption failed:", e);
                return null;
            }
        }
        
        function unlockVault() {
            const passkey = document.getElementById('passkey').value;
            
            if (!passkey) {
                showAlert('Please enter your passkey');
                return;
            }
            
            if (passkey.length < 8) {
                showAlert('Passkey must be at least 8 characters');
                return;
            }
            
            // Try to decrypt the files with this passkey to verify
            try {
                const encryptedFiles = localStorage.getItem('vaultFiles');
                if (encryptedFiles) {
                    const decrypted = decryptData(encryptedFiles);
                    if (!decrypted) {
                        showAlert('Incorrect passkey');
                        document.getElementById('passkey').value = '';
                        return;
                    }
                }
                
                // Success
                passkeyScreen.classList.add('hidden');
                vaultScreen.classList.remove('hidden');
                renderFileBrowser();
            } catch (e) {
                showAlert('Incorrect passkey');
                document.getElementById('passkey').value = '';
            }
        }
        
        function lockVault() {
            vaultScreen.classList.add('hidden');
            passkeyScreen.classList.remove('hidden');
            document.getElementById('passkey').value = '';
        }
        
        function setPasskey() {
            const newPasskey = document.getElementById('newPasskey').value;
            const confirmPasskey = document.getElementById('confirmPasskey').value;
            
            if (!newPasskey || !confirmPasskey) {
                showAlert('Please enter and confirm your passkey');
                return;
            }
            
            if (newPasskey.length < 8) {
                showAlert('Passkey must be at least 8 characters');
                return;
            }
            
            if (newPasskey !== confirmPasskey) {
                showAlert('Passkeys do not match');
                return;
            }
            
            // Set the passkey
            vaultState.passkey = newPasskey;
            localStorage.setItem('vaultPasskey', encryptData(newPasskey));
            
            // Switch to unlock form
            document.getElementById('newPasskeyForm').classList.add('hidden');
            document.getElementById('existingPasskeyForm').classList.remove('hidden');
            document.getElementById('newPasskey').value = '';
            document.getElementById('confirmPasskey').value = '';
            
            showAlert('Passkey set successfully', 'success');
        }
        
        function resetPasskey() {
            showConfirmation(
                'Reset Vault', 
                'This will delete ALL files in your vault and reset your passkey. Are you sure?',
                'exclamation-triangle',
                () => {
                    localStorage.removeItem('vaultPasskey');
                    localStorage.removeItem('vaultFiles');
                    vaultState.passkey = null;
                    vaultState.files = [];
                    
                    document.getElementById('newPasskeyForm').classList.remove('hidden');
                    document.getElementById('existingPasskeyForm').classList.add('hidden');
                    document.getElementById('passkey').value = '';
                    
                    showAlert('Vault has been reset', 'success');
                }
            );
        }
        
        function showChangePasskeyModal() {
            document.getElementById('currentPasskey').value = '';
            document.getElementById('newPasskeyModal').value = '';
            document.getElementById('confirmNewPasskey').value = '';
            changePasskeyModal.classList.remove('hidden');
        }
        
        function changePasskey() {
            const currentPasskey = document.getElementById('currentPasskey').value;
            const newPasskey = document.getElementById('newPasskeyModal').value;
            const confirmNewPasskey = document.getElementById('confirmNewPasskey').value;
            
            if (!currentPasskey || currentPasskey !== vaultState.passkey) {
                showAlert('Current passkey is incorrect');
                return;
            }
            
            if (!newPasskey || newPasskey.length < 8) {
                showAlert('New passkey must be at least 8 characters');
                return;
            }
            
            if (newPasskey !== confirmNewPasskey) {
                showAlert('New passkeys do not match');
                return;
            }
            
            // Re-encrypt all files with the new passkey
            try {
                const encryptedFiles = encryptData(vaultState.files);
                localStorage.setItem('vaultFiles', encryptedFiles);
                
                // Update passkey
                vaultState.passkey = newPasskey;
                localStorage.setItem('vaultPasskey', encryptData(newPasskey));
                
                // Close modal and show success
                changePasskeyModal.classList.add('hidden');
                showAlert('Passkey changed successfully', 'success');
            } catch (e) {
                showAlert('Failed to change passkey. Please try again.');
                console.error(e);
            }
        }
        
        function renderFileBrowser() {
            const fileBrowser = document.getElementById('fileBrowser');
            const breadcrumbs = document.getElementById('breadcrumbs');
            
            // Clear existing content
            fileBrowser.innerHTML = '';
            
            // Filter files for current path
            const currentFiles = vaultState.files.filter(file => file.path === vaultState.currentPath);
            
            // If no files, show empty state
            if (currentFiles.length === 0) {
                fileBrowser.innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-20">
                        <i class="fas fa-folder-open text-4xl mb-2"></i>
                        <p>This folder is empty</p>
                        <button id="addFilesHereBtn" class="mt-4 text-blue-400 hover:text-blue-300 underline flex items-center justify-center mx-auto">
                            <i class="fas fa-plus mr-1"></i> Add files here
                        </button>
                    </div>
                `;
                document.getElementById('addFilesHereBtn')?.addEventListener('click', () => document.getElementById('fileInput').click());
                return;
            }
            
            // Render breadcrumbs
            renderBreadcrumbs();
            
            // Render files and folders
            currentFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-thumbnail bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-700 transition duration-200 border border-gray-700';
                fileElement.dataset.id = file.id;
                
                if (file.type === 'folder') {
                    fileElement.innerHTML = `
                        <div class="p-4" onclick="navigateToFolder('${file.id}')">
                            <div class="bg-blue-900 bg-opacity-30 rounded-lg p-6 mb-2 flex justify-center">
                                <i class="fas fa-folder text-4xl text-blue-400"></i>
                            </div>
                            <div class="px-2 pb-3">
                                <h3 class="font-medium truncate text-center">${file.name}</h3>
                                <p class="text-xs text-gray-400 text-center">Folder</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-700 flex justify-end p-2">
                            <button class="text-red-400 hover:text-red-300 p-1 rounded-full" onclick="event.stopPropagation(); confirmDeleteFile('${file.id}')">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    `;
                } else {
                    // For files, we'll show a thumbnail if it's an image
                    let thumbnailContent = '';
                    if (file.mimeType.startsWith('image/')) {
                        thumbnailContent = `<img src="${file.content}" alt="${file.name}" class="w-full h-32 object-cover">`;
                    } else if (file.mimeType.startsWith('video/')) {
                        thumbnailContent = `
                            <div class="relative w-full h-32 bg-gray-700 flex items-center justify-center">
                                <i class="fas fa-play text-3xl text-blue-400"></i>
                                <div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-1 rounded">${formatDuration(file.duration)}</div>
                            </div>
                        `;
                    } else {
                        thumbnailContent = `
                            <div class="w-full h-32 bg-gray-700 flex items-center justify-center">
                                <i class="fas fa-file text-3xl text-blue-400"></i>
                            </div>
                        `;
                    }
                    
                    fileElement.innerHTML = `
                        <div onclick="viewFile('${file.id}')">
                            ${thumbnailContent}
                            <div class="p-3">
                                <h3 class="font-medium truncate text-center">${file.name}</h3>
                                <p class="text-xs text-gray-400 text-center">${formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-700 flex justify-end p-2">
                            <button class="text-red-400 hover:text-red-300 p-1 rounded-full" onclick="event.stopPropagation(); confirmDeleteFile('${file.id}')">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    `;
                }
                
                fileBrowser.appendChild(fileElement);
            });
            
            // Update storage usage
            updateStorageUsage();
        }
        
        function renderBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            breadcrumbs.innerHTML = '';
            
            // Split current path into parts
            const pathParts = vaultState.currentPath.split('/').filter(part => part !== '');
            
            // Add root link
            const rootLink = document.createElement('span');
            rootLink.className = 'cursor-pointer hover:text-blue-400 flex items-center';
            rootLink.innerHTML = '<i class="fas fa-home mr-1"></i> Vault';
            rootLink.dataset.path = '';
            rootLink.addEventListener('click', () => {
                vaultState.currentPath = '';
                renderFileBrowser();
            });
            breadcrumbs.appendChild(rootLink);
            
            // Add path parts
            let currentPath = '';
            pathParts.forEach((part, index) => {
                currentPath += `${part}/`;
                
                const separator = document.createElement('span');
                separator.className = 'mx-2 text-gray-500';
                separator.innerHTML = '<i class="fas fa-chevron-right"></i>';
                breadcrumbs.appendChild(separator);
                
                const link = document.createElement('span');
                link.className = 'cursor-pointer hover:text-blue-400 flex items-center';
                link.innerHTML = `<i class="fas fa-folder mr-1"></i> ${part}`;
                link.dataset.path = currentPath;
                link.addEventListener('click', () => {
                    vaultState.currentPath = currentPath;
                    renderFileBrowser();
                });
                breadcrumbs.appendChild(link);
            });
        }
        
        function navigateToFolder(folderId) {
            const folder = vaultState.files.find(f => f.id === folderId);
            if (folder) {
                vaultState.currentPath = folder.path + folder.name + '/';
                renderFileBrowser();
            }
        }
        
        function viewFile(fileId) {
            const file = vaultState.files.find(f => f.id === fileId);
            if (!file) return;
            
            vaultState.selectedFile = file;
            
            const fileViewerContent = document.getElementById('fileViewerContent');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            
            fileNameDisplay.textContent = file.name;
            
            if (file.mimeType.startsWith('image/')) {
                fileViewerContent.innerHTML = `<img src="${file.content}" alt="${file.name}" class="max-w-full max-h-full object-contain">`;
            } else if (file.mimeType.startsWith('video/')) {
                fileViewerContent.innerHTML = `
                    <video controls autoplay class="max-w-full max-h-full">
                        <source src="${file.content}" type="${file.mimeType}">
                        Your browser does not support the video tag.
                    </video>
                `;
            } else {
                fileViewerContent.innerHTML = `
                    <div class="text-center p-8">
                        <i class="fas fa-file text-5xl text-blue-400 mb-4"></i>
                        <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                        <p class="text-gray-300">${formatFileSize(file.size)}</p>
                    </div>
                `;
            }
            
            fileViewerModal.classList.remove('hidden');
        }
        
        function downloadSelectedFile() {
            if (!vaultState.selectedFile) return;
            
            const file = vaultState.selectedFile;
            const link = document.createElement('a');
            link.href = file.content;
            link.download = file.name;
            link.click();
            
            showAlert('Download started', 'success');
        }
        
        function showNewFolderModal() {
            document.getElementById('folderNameInput').value = '';
            newFolderModal.classList.remove('hidden');
            document.getElementById('folderNameInput').focus();
        }
        
        function createNewFolder() {
            const folderName = document.getElementById('folderNameInput').value.trim();
            
            if (!folderName) {
                showAlert('Please enter a folder name');
                return;
            }
            
            // Check if folder already exists in this path
            const existingFolder = vaultState.files.find(file => 
                file.path === vaultState.currentPath && 
                file.name === folderName && 
                file.type === 'folder'
            );
            
            if (existingFolder) {
                showAlert('A folder with this name already exists');
                return;
            }
            
            // Create new folder
            const newFolder = {
                id: generateId(),
                name: folderName,
                path: vaultState.currentPath,
                type: 'folder',
                createdAt: new Date().toISOString()
            };
            
            vaultState.files.push(newFolder);
            saveFilesToStorage();
            
            newFolderModal.classList.add('hidden');
            renderFileBrowser();
        }
        
        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const fileData = {
                        id: generateId(),
                        name: file.name,
                        path: vaultState.currentPath,
                        type: 'file',
                        mimeType: file.type,
                        size: file.size,
                        content: e.target.result,
                        createdAt: new Date().toISOString()
                    };
                    
                    // For videos, we'll add duration (simulated here)
                    if (file.type.startsWith('video/')) {
                        fileData.duration = Math.floor(Math.random() * 600) + 30; // 30-630 seconds
                    }
                    
                    vaultState.files.push(fileData);
                    saveFilesToStorage();
                    renderFileBrowser();
                };
                
                if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });
            
            // Reset file input
            event.target.value = '';
        }
        
        function confirmDeleteFile(fileId = null) {
            const fileToDelete = fileId || vaultState.selectedFile?.id;
            if (!fileToDelete) return;
            
            const file = vaultState.files.find(f => f.id === fileToDelete);
            if (!file) return;
            
            const action = file.type === 'folder' ? 'folder and all its contents' : 'file';
            
            showConfirmation(
                'Delete Confirmation', 
                `Are you sure you want to delete this ${action} "${file.name}"? This cannot be undone.`,
                'trash',
                () => {
                    if (file.type === 'folder') {
                        // Delete folder and all files within it
                        const folderPath = file.path + file.name + '/';
                        vaultState.files = vaultState.files.filter(f => 
                            !(f.path === file.path && f.name === file.name) && 
                            !f.path.startsWith(folderPath)
                        );
                    } else {
                        // Delete single file
                        vaultState.files = vaultState.files.filter(f => f.id !== fileToDelete);
                    }
                    
                    saveFilesToStorage();
                    if (!fileId) {
                        fileViewerModal.classList.add('hidden');
                    }
                    renderFileBrowser();
                }
            );
        }
        
        function searchFiles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderFileBrowser();
                return;
            }
            
            const filteredFiles = vaultState.files.filter(file => 
                file.name.toLowerCase().includes(searchTerm) && 
                file.path.startsWith(vaultState.currentPath)
            );
            
            const fileBrowser = document.getElementById('fileBrowser');
            fileBrowser.innerHTML = '';
            
            if (filteredFiles.length === 0) {
                fileBrowser.innerHTML = `
                    <div class="col-span-full text-center text-gray-400 py-20">
                        <i class="fas fa-search text-4xl mb-2"></i>
                        <p>No files match your search</p>
                    </div>
                `;
                return;
            }
            
            filteredFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-thumbnail bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:bg-gray-700 transition duration-200 border border-gray-700';
                fileElement.dataset.id = file.id;
                
                if (file.type === 'folder') {
                    fileElement.innerHTML = `
                        <div class="p-4" onclick="navigateToFolder('${file.id}')">
                            <div class="bg-blue-900 bg-opacity-30 rounded-lg p-6 mb-2 flex justify-center">
                                <i class="fas fa-folder text-4xl text-blue-400"></i>
                            </div>
                            <div class="px-2 pb-3">
                                <h3 class="font-medium truncate text-center">${file.name}</h3>
                                <p class="text-xs text-gray-400 text-center">Folder</p>
                            </div>
                        </div>
                    `;
                } else {
                    let thumbnailContent = '';
                    if (file.mimeType.startsWith('image/')) {
                        thumbnailContent = `<img src="${file.content}" alt="${file.name}" class="w-full h-32 object-cover">`;
                    } else if (file.mimeType.startsWith('video/')) {
                        thumbnailContent = `
                            <div class="relative w-full h-32 bg-gray-700 flex items-center justify-center">
                                <i class="fas fa-play text-3xl text-blue-400"></i>
                                <div class="absolute bottom-1 right-1 bg-black bg-opacity-70 text-white text-xs px-1 rounded">${formatDuration(file.duration)}</div>
                            </div>
                        `;
                    } else {
                        thumbnailContent = `
                            <div class="w-full h-32 bg-gray-700 flex items-center justify-center">
                                <i class="fas fa-file text-3xl text-blue-400"></i>
                            </div>
                        `;
                    }
                    
                    fileElement.innerHTML = `
                        <div onclick="viewFile('${file.id}')">
                            ${thumbnailContent}
                            <div class="p-3">
                                <h3 class="font-medium truncate text-center">${file.name}</h3>
                                <p class="text-xs text-gray-400 text-center">${formatFileSize(file.size)}</p>
                            </div>
                        </div>
                    `;
                }
                
                fileBrowser.appendChild(fileElement);
            });
        }
        
        function updateStorageUsage() {
            const totalSize = vaultState.files.reduce((sum, file) => sum + (file.size || 0), 0);
            const storageUsed = document.getElementById('storageUsed');
            const storageBar = document.getElementById('storageBar');
            
            storageUsed.textContent = formatFileSize(totalSize);
            
            // Calculate percentage (assuming 100MB max for demo purposes)
            const maxStorage = 100 * 1024 * 1024; // 100MB
            const percentage = Math.min((totalSize / maxStorage) * 100, 100);
            storageBar.style.width = `${percentage}%`;
            
            // Change color based on usage
            if (percentage > 90) {
                storageBar.classList.remove('bg-blue-600', 'bg-yellow-500');
                storageBar.classList.add('bg-red-600');
            } else if (percentage > 70) {
                storageBar.classList.remove('bg-blue-600', 'bg-red-600');
                storageBar.classList.add('bg-yellow-500');
            } else {
                storageBar.classList.remove('bg-yellow-500', 'bg-red-600');
                storageBar.classList.add('bg-blue-600');
            }
        }
        
        function saveFilesToStorage() {
            try {
                const encryptedFiles = encryptData(vaultState.files);
                localStorage.setItem('vaultFiles', encryptedFiles);
            } catch (e) {
                console.error("Failed to save files:", e);
                showAlert('Failed to save files. Please try again.');
            }
        }
        
        // Helper functions
        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatDuration(seconds) {
            if (!seconds) return '';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        function showAlert(message, type = 'error') {
            // Remove any existing alerts
            const existingAlert = document.querySelector('.alert-message');
            if (existingAlert) existingAlert.remove();
            
            const alert = document.createElement('div');
            alert.className = `alert-message fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} text-white flex items-center`;
            
            const icon = document.createElement('i');
            icon.className = type === 'error' ? 'fas fa-exclamation-circle mr-2' : 'fas fa-check-circle mr-2';
            alert.appendChild(icon);
            
            const text = document.createElement('span');
            text.textContent = message;
            alert.appendChild(text);
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('animate-bounce');
                alert.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => alert.remove(), 500);
            }, 3000);
        }
        
        function showConfirmation(title, message, icon, confirmCallback) {
            document.getElementById('confirmationTitle').innerHTML = `
                <i class="fas fa-${icon} text-red-400 mr-2"></i>
                <span>${title}</span>
            `;
            document.getElementById('confirmationMessage').textContent = message;
            
            // Store the confirm callback
            vaultState.confirmAction = confirmCallback;
            
            confirmationModal.classList.remove('hidden');
        }
        
        function executeConfirmedAction() {
            if (vaultState.confirmAction && typeof vaultState.confirmAction === 'function') {
                vaultState.confirmAction();
            }
            confirmationModal.classList.add('hidden');
        }
        
        // Make functions available globally for inline event handlers
        window.navigateToFolder = navigateToFolder;
        window.viewFile = viewFile;
        window.confirmDeleteFile = confirmDeleteFile;
    </script>
</body>
</html>

